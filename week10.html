<!DOCTYPE html>
<html>
  <head>
    <title>Week 10</title>
    <link href="styles.css" rel="stylesheet">
  </head>
  <body>
    <h1>Victor's Learning Journal at LBCC PHP/MySQL</h1>
    <nav>
        <a href="index.html">Table of Contents</a>&nbsp;|&nbsp;
        <a href="week9.html">Go to Week 9</a> |&nbsp;
	<!-- <a href="week8.html">Go to Week 8</a> |&nbsp; -->
        <a href="https://tzuang.webdevstudent.me/hw7/login.php">Login - Cheese Fan Club</a>
    </nav>
    <main>
      

      <article>
        <h3>Week 10</h3>
        <p>
          <time datetime="2021-11-4">November 4 2021</time>
        </p>

       
 <p>
     This week, we focused on learning cookies and sessions. Since the web is stateless, cookies and sessions are useful in creating state so that when a user logs in, we know that that user is logged in and can display data that is specific to that user. When the user logs out, then that data cannot be displayed. Cookies are stored on the browser while sessions are on the server. 
 </p><p>
The general idea of cookies and sessions is as follows. The user goes to a login page and enters in their information such as email and password. Then, if the form is complete, the data is sent to the database. If the email and password match one and only one row, then that is a good match. When that occurs, the user is logged in and the cookie is set or the session started. If the email and password are not a match or match more than one row, then there is a problem and the user is not logged in. In the latter case, the user can be redirected back to the login page. We also added a logout page, where the cookies or session data is  cleared. 
 </p><p>
Two functions were created this week to assist with the process of logging in. The first function was to redirect the user to a particular website. This function can take one argument which is the page to be redirected to. The default website it redirects to is index.php.
</p><blockquote><pre>

		function  redirect_user($page = 'index.php')  {
			
			$url = 'http://' . $_SERVER['HTTP_HOST'] . dirname($_SERVER['PHP_SELF']);
			
			$url = rtrim($url, '/\\');
			$url .= '/' . $page;

			header(“Location: $url”);
			exit();

		}
</pre></blockquote><p>
The code above creates an url with the http host and the directory name of the current website location. The dirname() truncates off the name of the current page. Then the rtrim() trims off both any backslashes or forward slashes from the right side of the url. Then, a backslash is added and the page name is added. The header() function then redirects the user to the absolute url that was created. Then the script is quit with the exit() function. 
 </p><p>
The second function we created checks to make sure the user entered in a valid email and password combination to login. 
</p><blockquote><pre>

		function check_login($connection, $email = '', $pass = '') 
</pre></blockquote><p>
Within this function, we check to make sure $email and $pass are not empty, and if they are not empty, we save the $email as $email = mysqli_real_escape_string($connection, trim($email)). The same is done with the password, such that $password = mysqli_real_escape_string($connection, trim($password));. Then, if there are no errors such as missing email or password, the query is created. The query created in this instance is “SELECT user_id, first_name FROM USERS WHERE email='$email' and password='$pass';. The $pass variable here is $pass = hash('sha512', $pass) and the result of the query is $result = @mysli_query($connection, $query). We then check to make sure that only one and only one row was returned. This is done by 
</p><blockquote><pre>
	      
		if(mysqli_num_rows($result) == 1) {
			$row = mysqli_fetch_array($result, MYSQLI_ASSOC);
			return[true, $row];
		}
</pre></blockquote><p>
The one row is then returned as the second element of an array; the first element being true in that the query was successful. The $row can then be accessed for the user_id and first_name from the database. In our case, the list() function is used to store the returned values in separate variables. 
 </p><p>
The book notes that it is important to make sure that cookies are sent from the server to the client before any other information. If the server tries to send the cookie after the browser has already gotten HTML, then a “headers already sent” error occurs. 
 </p><p>
The return value of the check_login() function is stored in two variables as such: list($check, $data) = check_login($connection, $_POST['email'], $_POST['pass']. Now, the $data array variable contains the row returned from the database and can be used to set cookie values.
 </p><p>
To set a cookie's value use setcookie('user_id', $data['user_id']). Now, the value of $_COOKIE['user_id'] can be accessed. The isset() function can be used to check if the value of the cookie is set. The setcookie() function actually has more parameters:
</p><blockquote><pre>

		setcookie(name, value, expiration, path, host, secure, httponly);
		
</pre></blockquote><p>
If expiration is set to time()+3600, that means the cookie expires in 60 minutes. Path can be set to '/' and host to ''. To delete a cookie, you can do setcookie('first_name', '', time()-3600, '/', '', 0, 0);.
 </p><p>
Switching to sessions, we learned that to start a session, you use the function session_start(). Like cookies, sessions need to be started before any data goes to the browser. When you start a session, a cookie with name PHPSESSID and a hex value is stored on the browser. After the session starts, you can set values by using $_SESSION['first_name'] = $data['first_name']. 
 </p><p>
The book emphasizes how each script must first enable sessions with session_start(). This gives the script access to the session so it can read the session variables such as $_SESSION['first_name']. 
 </p><p>
The book also showed an interesting technique to change the page navigation links based on whether the user is logged into a session. By using if(isset($_SESSION['user_id'])), if the user has the SESSION variable for user_id set, then we can show a Logout link. Otherwise, we show a Login link.
 </p><p>
To remove session data such as when the user logouts, we use 
</p><blockquote><pre>

		$_SESSION = []; 	//to clear the variables  
		session_destroy(); 	// to stop the session
		setcookie('PHPSESSID', '', time()-3600, '/', '', 0, 0); 		//delete session cookie 

</pre></blockquote><p>
All these three steps are needed. So you need to clear the session variables, stop the session, and delete the session cookie on the user's browser.
 </p><p>
The book warns us to not set $_SESSION to NULL and to not use unset($_SESSION). This can cause server problems. 
 </p><p>
For improving security of sessions, we create the following SESSION variable:
</p><blockquote><pre>
	      
		$_SESSION['agent'] = sha1($_SERVER['HTTP_USER_AGENT']);

</pre></blockquote><p>
Then, for pages where the user must be logged into a session, we can check whether the $_SESSION['agent'] is set and whether this session agent value is equal to that other pages' sha1($_SERVER['HTTP_USER_AGENT']). This prevents another user from accessing the session if they are using a different browser or operating system. 
 </p><p>
The book also talks about session_regenerate_id() which provides a new session ID when a user logs in. 
	 </p>    
	     
	      
	      
	      
	      
	      
	      
	      
	      
	      
	      
	      
	      
<p class="supplemental">
           Supplemental Learning
          </p>
          <p>
This week I wanted to learn CSS flexbox and the cards design. I was able to use it for the <a href= "https://tzuang.webdevstudent.me/hw6/list_users.php">homework</a> this week and it allowed me to easily lay down tiles for registered users. Before learning flexbox, I was thinking of all these unnecessarily complicated ways to lay images down in a tile going from left to right and down from top to bottom. I was thinking of having a count variable in PHP and adding 1 for each user, and if the modulus 3 of it had a remainder of 0, then it would be the first item of that row, and if it had a remainder of 1, it would be the middle item, and if the remainder was 2, it would be the right item. Meanwhile, if the modulus was zero, then it would start a new row. Thus, the page would be laid out with 3 items per row going from top to bottom. I was thinking this could possibly work, but it does seem so unnecessarily difficult. It would involve loops, and since you don't know how many items there are at any one time since you could always have new registered users, then it would probably need a while loop. 
 </p><p>
Luckily, there is CSS flexbox. CSS flexbox was the layout I wanted without all the complicated PHP logic. Basically, you have a div container with display set to flex. Then all the items in the container are laid out depending on the settings you give to that container. If my div has class of container, then here was my CSS:
</p><blockquote><pre>
                  div.container {
                    display: flex;
                    flex-direction: row;
                    flex-wrap: wrap;
                    justify-content: space-evenly;
                  }
 </pre></blockquote><p>
The display:flex tells CSS that this div container is a flex container and its children can be moved around based on the flex settings. The flex-direction:row means the children are laid out horizontally with the row as its main axis. The flex-wrap: wrap means that the children in this case will move onto the next row instead of trying to be all on the same row. And justify-content: space-evenly means that the children will be spaced evenly on the main-axis row. Within this div container, I placed a number of div children and I set the div children to a fixed width and height. Thus, then the children reached the end of the row, they would wrap into the next row. 
</p> <p>
I would say I am a visual learner and this <a href="https://css-tricks.com/snippets/css/a-guide-to-flexbox/" >website</a> was really helpful in visually showing the flexbox properties and what the container and children look like.
   </p>     
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
   
          
          
      </article>
    </main>
    <hr>
    <footer>
      Last updated 11/4/2021        
    </footer>
  </body>
</html>
