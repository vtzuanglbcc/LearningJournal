<!DOCTYPE html>
<html>
  <head>
    <title>Week 7</title>
    <link href="styles.css" rel="stylesheet">
  </head>
  <body>
    <h1>Victor's Learning Journal at LBCC PHP/MySQL</h1>
    <nav>
        <a href="index.html">Table of Contents</a>&nbsp;|&nbsp;
        <a href="week6.html">Go to Week 6</a> |&nbsp;
        <a href="https://tzuang.webdevstudent.me/add_depts.php">Add Departments Website</a>
    </nav>
    <main>
      

      <article>
        <h3>Week 7</h3>
        <p>
          <time datetime="2021-10-15">October 15 2021</time>
        </p>
        <p>
         This week, we created registration and login forms that were connected to the database. I found this really exciting and interesting because this 
allows us to create a user in the database, then have the user log in with the email and password they created. In doing so, we 
no longer need to use hardcoded passwords to login, but can have a changing set of emails and passwords to login. To start doing this, we first created a PHP script to 
connect to the database. This was covered in the previous week but it was good to review all the aspects of the 
database connection file. Essentially, we need to connect to a database which will contain the table we are accessing. The database connection will
have a database user name and password, in addition to the database host which is set to 127.0.0.1 and the name of the database itself. This is all
set up in the cPanel mySQL Database area. Simply create a database of your liking with your chosen name, then link that
database to a username and set up a database password for that user to access that database. 

        </p>
        <p>I ended up setting up some more databases for practice as this is new to me and it helps to repeat it several times. After setting up the database, I also
set up the FTP again from Visual Studio Code to the FTP server on the cPanel. This allows for near instant upload of files to the server after saving the file. To
set the sFTP, you need to find the FTP host name which is in the FTP area of cPanel. I changed to protocol to ftp and the port to 21. The username and password used
here is different from the database login. It is the credentials used to login to cPanel. And the remote path is where the location on the server where the files will be synced
to on the server. Once this is all set up, it makes creating scripts and instantly seeing the changes on the webserver simple.

        </p>
        
        <p>
Once those two steps are complete, I started to work on the registration.php site. This site is not complicated but I did run into several bugs along the way. Most notably, I missed a few
semicolons which took a while to find and also the encryption SHA function the textbook uses does not work for me to I tried a different encryption function and it seemed to work. In the textbook,
the author uses this SQL query to add an entry to the database:
        </p>
        <blockquote><pre>
            $query = "INSERT INTO users (first_name, last_name, email, pass, registration_date)
	                    VALUES ('$first_name', '$last_name', '$email', SHA2('$pass', 512), NOW() )";

        </pre></blockquote>
        <p>
          I tried to do this multiple times but it never worked. Eventually, I Googled PHP and SHA and I found a function called hash(). I tried doing this instead:

          
        </p>
        <blockquote><pre>
            $hash = hash('sha512', $pass);
            $query = "INSERT INTO users (first_name, last_name, email, pass, registration_date)
	                    VALUES ('$first_name', '$last_name', '$email', $hash, NOW() )";

        </pre></blockquote>
        <p>
          This actually worked and I was able to see a really long alphanumeric password in the database for that entry. I don't know if this is the correct way to do it but basically the hash() function takes the $pass variable and creates a hash using
'sha512' encryption. Then that value is stored in $hash and passed into the database query. Hopefully, this is an acceptable way to do it. I did find it strange that I could not find a PHP manual page about SHA() but I was glad to find a hash() function instead.

        </p>
        <p>
          The rest of the registration form was alot of checking to make sure the user entered in the values. For example, if the user did not enter in a first name, then the $errors array would append another message by:

        </p>
        <blockquote><pre>
            $errors[] = "You did not enter in a first name.";
        </pre></blockquote>
        <p>
           
The PHP syntax for pushing an entry into the array is very interesting! It is simply the name of the array variable with two brackets []. If the user did enter in the text entry, then the value would be trimmed with the trim() function and then the value could be set to the 
variable to use in the query. 
          
          
        </p>  
        <p>Another interesting function that came up was mysqli_real_escape_string. I tried to use this to resolve the SHA() problems but it wasn't helpful in that specific regard. Instead, the mysqli_real_escape_string is helpful in cleaning out special characters in a string so the SQL query will run correctly. According to the 
PHP manual, the mysqli_real_escape_string procedural style is to have the database connection as the first parameter and the string as the second paramter:
</p>
        <blockquote><pre>
            $first_name = mysqli_real_escape_string($connection, trim($_POST['first_name']));
          
        </pre></blockquote>
        <p>$connection is the connection between mySQL database and PHP, while the trim($_POST['first_name']) is simply a user input string that has been trimmed. 
        </p>
<p>          I did some experimenting with mysqli_real_escape_string($connection, trim($_POST['first_name']));. Essentially, if you omit the mysqli_real_escape_string, if the string the user enter has mySQL escape sequences, those escape sequences will be interpreted. For example, a \n will become a newline, and a \t will become a tab. Thus, when I entered in "\n\r\t\\\\Hello" for first_name without mysqli_real_escape_string, it became a newline, carriage return, a tab, and two backslashes. If I used mysqli_real_escape_string with the $connection and string value entered, then it would simply be saved into the database uninterpreted as the literal \n\r\t\\\\Hello. I thought this was so interesting and so I makes sense to use the mysqli_real_escape_string(), because you do not want the user to to entering in commands into the input boxes that the computer accidently interprets.
        </p>
<p>Another example detailed in the book of the important utility of mysqli_real_escape_string() was how mysqli_real_escape_string() prevents the breaking of the mySQL query to insert values. If the user's name was O'brien, the single quote will break the SQL query to insert the value. Here is a code fragment:

        </p>
       
        <blockquote><pre>
            INSERT INTO USERS (first_name, last_name, email, pass, registration_date) VALUES('O\'brien', 'O'brien', ...
            
         </pre></blockquote>
         
          
          <p>
           The first_name is processed through mysqli_real_escape_string() while the last_name is not. This results in a last name of 'O'brien' in the SQL query which creates an error in the query. Meanwhile, with mysqli_real_escape_string(), the first name's single quote is escaped out and the query is able to run successfully ('O\'brien'). Another important thing to emphasize is that mysqli_real_escape_string() requires a database connection to work, so be sure to import the database connection file before calling this function.
        </p><p>
Another question I had was why go through all this trouble hashing a password when you still only use your password to login and not the hashed password. I Googled this and it sounds like the purpose of hashing is to prevent a database leak from revealing all these passwords that are saved in the database. I am guessing it is not simple to unhash a password so a hashed password adds complexity to determining the password.
        </p><p>
The rest of the register.php file was pretty understandable and I ended up making mistakes in the echo statements by forgetting to put the semicolon at the end of statements. For example, if the user forgot to input the first name or last name, a message would be stored in the $errors array and then a foreach loop was used to display the messages.  
          </p>
          
          <blockquote><pre>
              ############################################
         </pre></blockquote>
            
            <p>
              The WHERE tells SQL which rows to return, while the column
              name after SELECT determines which columns to return from
              the query. Also, IS NULL means that there is not a value.
              This is not the same as ''. '' is an empty string, while
              IS NULL is just no value. Thus, WHERE email IS NULL and
              WHERE email = '' are different because WHERE email IS NULL
              means there is no value there, while WHERE email = '' is
              that the email is an empty string.
            
            </p>
            <blockquote><pre>
            SELECT * FROM USER 
            WHERE password = 'SHA2("white walker", 400)';
             </pre></blockquote>
            
            <p>
              An unusual thing I noticed was that in this previous query, it
              only worked when the quotation for "white walker" matched exactly
              what was in the database. Thus when single quotes were used, the
              query returned zero results. Here is an example of using BETWEEN:
              
            </p>
            <blockquote><pre>
            SELECT first_name, last_name 
            FROM USER 
            WHERE user_id BETWEEN 5 AND 10;
            </pre></blockquote>
            
            <p> 
              This returns all the first and last names from the USER table 
              where the user id is between 5 and 10 inclusive of both 5 and 10.
              Instead of BETWEEN, you could also use NOT BETWEEN which would give
              values outside of 5 to 10. An interesting aspect of MySQL is that
              TRUE equals 1 and FALSE is 0, and adding TRUE + TRUE will equal 2.
            </p>
            <p>
              LIKE and NOT LIKE are very useful in string comparison. They can be used
              with _ and %, with _ indicating one character and % indication 0 or more
              characters. In these two examples, the NOT LIKE '%GMAIL%' will screen out
              any users where their email address has gmail in it. The search is not 
              case sensitive so 'gmail' or 'Gmail' or 'GMAIL' would all be screened
              out. The second query would only select for users where their email
              has 'gmail' in it.
              
            </p>
              <blockquote><pre>
              SELECT first_name, last_name, email_address 
              FROM USER 
              WHERE email_address NOT LIKE '%GMAIL%';
              
              SELECT first_name, last_name, email_address 
              FROM USER 
              WHERE email_address LIKE '%GMAIL%';
            </pre></blockquote>
            
            <p> 
              If you wanted to search for an underscore or % sign in a LIKE
              statement, when you need to escape it with a backslash. If you
              used LIKE '__', this would search for any two letters together.
              ORDER BY lets you order the search results. ASC and DESC stand
              for ascending order or descending order. 
              
            </p>
            
            
            
            <blockquote><pre>
            SELECT first_name, last_name 
            FROM USER 
            ORDER BY last_name ASC, first_name ASC;
             </pre></blockquote>
            
            <p> 
              This query will sort by ascending last name first, then sort
              by ascending first name. After ordering
              the results, you can also LIMIT results returned. You want to
              do LIMIT last, after the results have been ordered. If you 
              type LIMIT 10, it will result in only the first 10 results returned. 
              If you wanted the 11th result to the 20th, then you would 
              type LIMIT 10, 10: start from the index 10 and give 10 more
              results. The 11th result has an index 10 similar to PHP arrays.
              This query would give 3 results starting at the 6th result:
            </p>
            
            <blockquote><pre>
            SELECT first_name, last_name 
            FROM USER ORDER BY last_name ASC, first_name ASC 
            LIMIT 5, 3;
            </pre></blockquote>
            
            <p>
              Another interesting code is that to see the last 5 people
              who registered, sort by DESC registered_date and then limit
              to 5 results. An important thing to remember is that the 
              LIMIT 5, 3 means that you are starting at the sixth entry, and
              you want 3 entries returned. This is very useful in returning
              pages of results.
            </p>
            
            <p>
              UPDATE is useful in updating data in the table. It is important
              to user WHERE to specify which row of  data to update and to
              use the primary key to determine which row. Also, never
              update the primary key, and use LIMIT 1 to only update 1 row. 
              An example would be 
            </p>
              
              <blockquote><pre>
              UPDATE USER
              SET email="newemail@gmail.com"
              WHERE user_id = 5 
              LIMIT 1;
              </pre></blockquote>
            
            <p>
              DELETE FROM is useful to delete rows. If you forget the specify
              WHERE, then it will delete the contents of the whole table.
              Similar to UPDATE, LIMIT 1 will limit to just deleting one
              row. An example would be 
            </p>
            
              <blockquote><pre>
              DELETE FROM USER
              WHERE user_id = 5 
              LIMIT 1;
              </pre></blockquote>
            <p>
              DROP TABLE USER will delete the USER table and all its data. 
              TRUNCATE TABLE USERwill empty the USER table.
              DROP DATABASE <dbname> will delete the whole database.
              Functions in mySQL should not have a space between the
              function name and opening parenthesis.
              </p>
              <p>
                CONCAT() concatenates values such as CONCAT(first_name, " ",
                last_name). Alias can help with CONCAT(). For example,
                it can make sense to do CONCAT(first_name, " ", last_name) AS
                full_name.
            </p>
            
                <blockquote><pre>
                SELECT CONCAT(first_name, " " , last_name) AS full_name 
                FROM USER;
                </pre></blockquote>
              <p>
                The column will be labeled full_name and list all the
                concatenated names. This will be helpful when connecting
                mySQL to PHP to work with full_name instead of a 
                CONCAT(...) which may have various punctuation within the
                function. Aliases are case sensitive strings. In mySQL,
                use the alias in the rest of the query-- for example in
                WHERE full_name = "Peter Parker" and ORDER BY full_name. 
                LENGTH() function will determine the length of a string.
            
            </p>
            <blockquote><pre>
                  SELECT LENGTH(last_name) AS L, last_name 
                  FROM USER 
                  ORDER BY L DESC 
                  LIMIT 1;
                  </pre></blockquote>
            <p>
              This query orders the length of the last name by
              longest first and displays only the longest last name
              from the USER table. CONCAT_WS() is very useful in that
              it will concat with the first parameter being the 
              separator. SELECT CONCAT_WS(" ", first_name, middle_name, last_name) AS Name
              FROM USER will concatenate the non-null values. So you could
              have "Luke Skywalker" or "Luke John Skywalker". The " " is the
              separator.
            </p>
            <p>
              Some math functions include CEILING(num), FLOOR(num), FORMAT(number, <number of decimal places>),
              MOD(num1, num2) which calculates the remainder, RAND() which is a 
              random number from 0 to 1.0, ROUND(num1, num2) which rounds num1 to
              num2 decimal places, and SQRT(num). Interestingly, RAND() can
              return queries in a random order. Example: SELECT * FROM USER ORDER
              BY RAND(). FORMAT() and CONCAT() can be used together for 
              dollar values. For example, FORMAT(3000.4, 2) will result in
              3,000.40, and CONCAT('$', FORMAT(3000.4, 2) will result in 
            $3000.40. So CONCAT() with FORMAT() can turn numbers into 
              currency numbers.
              </p>
              
              <p>
                There are numerous useful Date and Time functions. Date(datetime)
                will return the date value such as 2021-10-07. HOUR(datetime) 
                will return 22 for 10PM. MINUTE(datetime) could return 47. 
                DAYOFMONTH(datetime) could return 7. MONTHNAME(datetime) can
                return October while MONTH(datetime) returns 10 for October.
                NOW() returns the current date and time while CURDATE() is the 
                current date and CURTIME() is the current time.
            </p>
            <p> 
              DATE_FORMAT() is a very useful function for display a particular
              date in a various number of different formats.
              For example, SELECT DATE_FORMAT(NOW(), '%W, %M %D at %l %p')
              will result in displaying the current date and time in this
              format: Thursday, October 7th at 6 PM. The first parameter
              of DATE_FORMAT is the datetime, and the second parameter
              is a string that is the formatting you want to display.
              
              
            </p>
            <p>
              Interestingly, to see what the time or date is on the client's
              computer, you need to use JavaScript and not PHP or MySQL.
            </p>
          <p class="supplemental">
           Supplemental Learning
          </p>
          <p>
           This week, we also connected PHP to the mySQL database. I thought it would
            be important to review the steps for future reference. 
          </p>
            
            
            <ul>
              <li>
                In VSCode, go to View -> Extensions and download SFTP
              </li>
              <li>
                In VSCode, within an Opened Folder, go to View -> Command Palette and type SFTP.
                An SFTP JSON file will appear in your Folder. Then, fill in the JSON file. 
                
       
          <blockquote><pre>
       
            "name": "arbitrary folder name",
            "host": "Put your FTP Server here",
            "protocol": "ftp",
            "port": 21,
            "username": "Put FTP username",
            "password": "Put cPanel login info",
            "remotePath": "/public_html",
            "uploadOnSave": true
          </pre></blockquote>
          </li>
          <li>
          This sftp.json file stays local on your computer. Now create another file
          called db.php which actually is uploaded to the server and used on the 
          server to connect to the database. In db.php, include this:
          <blockquote><pre>
          
          &lt;?php
          
          $host = "127.0.0.1";
          $user = "your database username found in mySQL Databases";
          $pass = "your database password created when adding mySQL user";
          $db = "the name of the exact database you created that you want to access";
          $port = 3306;
            
          // this step makes the connection to the database using <a href="https://www.php.net/manual/en/mysqli.construct.php">mysqli_connect</a>
          $connection = mysqli_connect($host, $user, $pass, $db, $port);
          
          if (mysqli_connect_errno()) {
            die("DB connection failed: " . mysqli_connect_error() . " (" .
              mysqli_connect_errno() . ")" 
              );
          } else {
            echo "DB connection successful.";
          }
          ?&gt;
          </pre></blockquote>
              </li>
              <li>
                The above db.php is then uploaded by FTP to your 
                server by right clicking on it and clicking upload. 
                I made the mistake of having this file or other files
                within the .vscode subfolder at the same level as sftp.json.
                Don't do this! It does not work. Instead, the db.php
                and other files in you folder should be immediately
                within the Folder you created for uploading to the FTP.
              </li>
              <li>
                Once db.php is uploaded, simply go to your URL and 
                append the URL with db.php. It should show a message
                whether you connected succesfully to the database or 
                not. When it works, that db.php file can be require()
                by any other file that needs that same database connection.
     
          <blockquote><pre>
              &lt;?php
                require('db.php');
              ?&gt;
          </pre></blockquote>
                
              </li>
              <li>
                To create a database query, type the query as a string
                and save it to a variable $query. Then use the mysqli_query()
                to pass the $connection previously created in db.php 
                and $query.
          
          <blockquote><pre>
                $query = "SELECT * FROM USER";
                $result = mysqli_query($connection, $query);
                while ($row = mysqli_fetch_assoc($result)) {
                    echo "$row['user_id'] . " " . $row['first_name']";
                }
          
          </pre></blockquote>
              </li>
              <li>
                mysqli_query() performs a query, and returns either false
                or a mysqli_result object if it is a sucessful query
                using SELECT, SHOW, DESCRIBE, or EXPLAIN. Other successful
                mysqli_query() return true.
              </li><li>
                The mysqli_fetch_assoc() returns an associative array
                on which the data can be accessed and displayed.
              </li>
            </ul>
            <h4>Additional references</h4>
            <ul>
              <li><a href="https://www.php.net/manual/en/mysqli.query.php">mysqli_query()</a>: Performs query on database and </li>
              <li><a href="https://www.php.net/manual/en/mysqli-result.fetch-assoc.php">mysqli_fetch_assoc()</a>: Fethes row as associative array</li>
              <li><a href="https://www.php.net/manual/en/mysqli.construct.php">mysqli_connect()</a>: Opens new connection to mySQL server</li>
              <li><a href="https://www.php.net/manual/en/mysqli.connect-error.php">mysqli_connect_error()</a>: Returns description of last connection error</li>
              <li><a href="https://www.php.net/manual/en/mysqli.connect-errno.php">mysqli_connect_errno()
</a>: Returns error code from last connect call</li>
              
                
                
            
              
            </ul>
       
          
          
          
      </article>
    </main>
    <hr>
    <footer>
      Last updated 10/7/2021        
    </footer>
  </body>
</html>
